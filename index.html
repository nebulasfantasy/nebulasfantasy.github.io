<!DOCTYPE html>
<html>
<title>Nebulas Fantasy</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/star.css" rel="stylesheet">
<link href="css/NF.css" rel="stylesheet">
<style>
    .buyPlayer {
        margin: auto;
        width: 100%;
        padding: 5px;
    }

    img {
        display: block;
        margin: auto;
    }

    .howtoplay {
        font-weight: bold;
        text-align: center;
    }

    .sectionTitle {
        font-weight: bold;
        padding: 10px;
    }

    /* Create two equal columns that floats next to each other */



    /* Clear floats after the columns */

    .row:after {
        content: "";
        display: table;
        clear: both;
    }

    li {
        margin: 20px 0;
    }

</style>

<body>
    <div class="container">
        <div class="w3-white w3-xlarge" style="max-width:1200px;">
            <div class="w3-bar">
                <a href="./index.html" class="w3-bar-item w3-button">Home</a>
                <a href="./players.html" class="w3-bar-item w3-button">Portfolio</a>
                <a href="./market.html" class="w3-bar-item w3-button">Market</a>
                <a href="./leaderboard.html" class="w3-bar-item w3-button">Leaders</a>
                <a href="./trading.html" class="w3-bar-item w3-button">Exchange</a>
                <a href="./about.html" class="w3-bar-item w3-button">About</a>
                <a href="" id="contractAddress" class="w3-bar-item w3-button">Contract</a>
                <a href="./ch/index.html" class="w3-bar-item w3-button" style="float:right">中文</a>
                <!-- <span class="w3-bar-item" id="pool" style="float:right"></span> -->
            </div>
        </div>

        <header class="w3-display-container w3-content w3-wide" style="max-width:1200px" id="home">
            <img class="w3-image" src="./img/banner0.png">
        </header>

        <div class="infobar">
            <div class="row">
                <div class="col-sm-4">
                        <span class="infobaritems">Network: <span id="network"></span></span> 
                </div>
                <div class="col-sm-4"> 
                        <span class="infobaritems">Prize Pool: <span id="pool"></span></span> 
                </div>
                <div class="col-sm-4">
                        <span class="infobaritems"># of Avatars: <span id="amountAvatars"></span></span> 
                </div>
            </div>
        </div>


        <div style="max-width:2000px;margin-top:50px">
            <div class="row">
                <div class="col-sm-7">
                    <h2 class="sectionTitle">Avatar Lottery</h2>
                    <div class="buyPlayer">
                        <img class="img-center" id="randomPlayerCard" style="width:90%; height:90%;" src="./img/lottery_quesitonMark.png">
                        <!-- <div style="margin:5px; color:red;text-align: center"> <h4>the drawing function is under maintainance.. please use <a href=""./market.html"">Market</a> for now </h4> </div> -->
                        <button id="claimButton" type="button" class="btn btn-primary" style="display: block; margin: 20px auto;">
                            CLAIM
                        </button>
                    </div>
                    <h3 style="text-align: center">The market is opening!</h3>
                    <h3 style="text-align: center" id="currentPrice"></h3>
                </div>
                <div class="col-sm-5">
                    <h2 class="sectionTitle">What is an Avatar?</h2>
                    <div class="board" style="margin-right:20px;text-align: justify">
                        <h4>
                            
                            <ul>
                                <li>An "Avatar" on Nebulas Fantasy is a NRC 721 token on Nebulas Blockchain and an embodiment
                                    of soccer players in World Cup 2018</li>
                                <li>Avatars are created with a random talent level (1-5 stars)</li>
                                <li>Avatars accumulate points according to real world performance and talents</li>
                                <li>Spend as low as 0.1 NAS to claim your first Avartar! Lottery price will increase 0.1 NAS
                                    every 50 players</li>
                                <li>Lottery payment will be deposited into the total prize pool directly</li>
                                <li>Desire a specific Avatar? go to the
                                    <a href="./market.html" target="_blank"> Avatars Market</a> and pay a premium</li>
                                <li>You need a Chrome Extension to load your
                                    <a href="https://chrome.google.com/webstore/detail/nasextwallet/gehjkhmhclgnkkhpfamakecfgakkfkco" target="_blank">Nebulas Wallet</a>
                                </li>
                            </ul>
                        </h4>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">Nebulas Transaction</h3>
                    </div>
                    <div class="modal-body">
                        <div>
                            <h4 id="modal-status"></h4>
                            <div class="panel panel-default panel-pet" style="width:50%;margin: auto" id="modal-txresult">
                                <div class="panel-heading">
                                    <h3 id="name"></h3>
                                </div>
                                <div class="panel-body">
                                    <img alt="140x140" id="playerCard" class="img-rounded img-center" style="width: 100%;" data-holder-rendered="true">
                                    <br/>
                                    <strong>Talent</strong>:
                                    <span id="talent" class="stars-container stars-5">★★★★★</span>
                                    <br/>
                                </div>
                            </div>
                            <div class="loader" id="loader3" style="display:hide;margin:auto"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" id="confirm" data-dismiss="modal">OK</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div style="max-width:2000px;margin-top:50px">
            <h2 class="sectionTitle">Statistics</h2>
            <div class="row">
                <div class="col-md-6">
                        <div class="loader" id="loader1" style="display:hide;margin:auto"></div>
                        <div id="talentchart" style="width: 800px; height: 500px;"></div>
                </div>
                <div class="col-md-6">
                        <div class="loader" id="loader2" style="display:hide;margin:auto"></div>
                        <div id="playerchart" style="width: 800px; height: 500px;"></div>  
                </div>
            </div>
        </div>

        <!-- About Section -->
        <div style="max-width:2000px;margin-top:50px">
            <h2 class="sectionTitle">How To Play</h2>
            <div class="row">
                <div class="col-sm-4">

                    <img class="img-center"  style="max-width:1200px" src="./img/home/create.png">
                    <br/>
                    <h3 class="howtoplay">Claim Your Avatar</h4>
                </div>
                <div class="col-sm-4">

                    <img class="img-center" style="max-width:1200px" src="./img/home/game.png">
                    <br/>
                    <h3 class="howtoplay">Accumulate Points</h4>
                </div>
                <div class="col-sm-4">
                    <img class="img-center" style="max-width:1200px" src="./img/home/win.png">
                    <br/>
                    <h3 class="howtoplay">Watch and Win</h4>
                </div>
            </div>
        </div>


        <!-- <br/>
        <div  style="max-width:2000px;margin-top:50px">
            <h2 class="sectionTitle">What is Nebulas Fantasy?</h2>
            <br>
            <ul>
                    <li><h4> Nebulas Fantasy is a decentralized application that operates on the Nebulas Network.</h4></li>                  
                    <li><h4> We setup a fantasy platform for soccer fans to enjoy World Cup 2018 in a unique way </h4></li>
                    <li><h4> Soccer fans can own soccer players on Nebulas blockchain, gain points according to the players’ performance in the real World Cup matches, and win NAS as prize!</h4></li>
                    <li><h4> see <a href="./about.html">ABOUT</a> page for more information</h4></li>
            </ul> 
        </div> -->

        <!-- Footer -->
        <footer class="w3-container w3-padding-64 w3-center w3-large">
            <p>Powered by Nebulas Fantasy Team</p>
            <p>nebulas.fantasy@gmail.com</p>
        </footer>

        <!-- End page content -->
    </div>
    <script src="lib/chart.js"></script>
    <script src=lib/jquery-3.3.1.min.js></script>
    <script src="bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src=lib/nebpay.js></script>
    <script src="https://cdn.jsdelivr.net/npm/nebulas@0.5.2/dist/nebulas.js"></script>
    <!-- <script src=lib/nebulas.js></script> -->
    <script src=lib/bignumber.min.js></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src=address.js></script>
    <script>

        var nebulas = require("nebulas"),
            neb = new nebulas.Neb();
        var NebPay = require("nebpay");
        var nebPay = new NebPay();
        var serialNumber;
        Account = nebulas.Account;


        var mainnetUrl = "https://pay.nebulas.io/api/mainnet/pay",
            testnetUrl = "https://pay.nebulas.io/api/pay";


        var ownerAddress;
        var explorerTex, explorer, chainId, callbackUrl, NebHttpRequest;

        if (mainnet == false) { // test net
            // const contractAddress =  require("address");//"n1wtjL3KMVNTV3gsWhJibnNMmr6HJHKwBW2";
            ownerAddress = "n1RQYWMLqy1twJhfYxPk4SFx7wdfeq31pMX";
            NebHttpRequest = "https://testnet.nebulas.io";
            chainId = 1001;// test net
            callbackUrl = testnetUrl;
            explorerTx = "https://explorer.nebulas.io/#/testnet/tx/";
            explorer = "https://explorer.nebulas.io/#/testnet/address/";
        } else {
            // //main net 
            ownerAddress = "n1bveJ8tkb1DDECgHvknRFZesJqeaL2iKNt";
            NebHttpRequest = "https://mainnet.nebulas.io";
            chainId = 1;// mainnet net
            callbackUrl = mainnetUrl;
            explorerTx = "https://explorer.nebulas.io/#/mainnet/tx/";
            explorer = "https://explorer.nebulas.io/#/mainnet/address/";
        }

        neb.setRequest(new nebulas.HttpRequest(NebHttpRequest));
        $("#contractAddress").attr('href', explorer + contractAddress).attr('target', "_blank");




        function init() {
            window.addEventListener('message', networkUpdate); 

            $("#loader1").css("display", "block");
            $("#loader2").css("display", "block");

            var claim = $('#claimButton');
            claim.click(function (e) {
                e.preventDefault();
                buy();
            })
            updateStatus();
            setInterval(updateStatus,10000);
            getCurrentPrice();


            getTotalToken();
        };

        





        function getCurrentPrice() {
            var testcontract;
            var callJSONs = {
                from: ownerAddress, // get address string
                to: contractAddress, // get the contract string
                value: "0",
                nonce: 0,
                gasPrice: "200000",
                gasLimit: "1000000",
                contract: testcontract
            }

            // get the token Id owned by the address
            testcontract = { "function": "getDrawPrice", "args": "" };
            callJSONs.contract = testcontract;
            neb.api.call(callJSONs)
                .then(function (resp) {
                    console.log(resp)
                    // $("#prize").show().text("Total prize pool:  " + String(parseInt(JSON.parse(resp.result)) / 1e18) + " NAS");
                    $("#currentPrice").show().text("current price: " + String(parseFloat(JSON.parse(resp.result))) + " NAS");
                }
                )
        }

 



        function buy() {
            // read the price first
            var testcontract;
            var callJSONs = {
                from: ownerAddress, // get address string
                to: contractAddress, // get the contract string
                value: "0",
                nonce: 0,
                gasPrice: "200000",
                gasLimit: "1000000",
                contract: testcontract
            }

            // get the token Id owned by the address
            testcontract = { "function": "getDrawPrice", "args": "" };
            callJSONs.contract = testcontract;
            neb.api.call(callJSONs)
                .then(function (resp) {
                    var to = contractAddress;
                    var value = parseFloat(JSON.parse(resp.result));// need to change
                    var callFunction = "mint";
                    var callArgs = "";
                    console.log(value)
                    serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
                        listener: mintListener,        //设置listener, 处理交易返回信息
                    });

                }
                )

        }

        var txhash;

        function mintListener(resp) {
            txhash = resp.txhash;
            neb.api.getTransactionReceipt({
                hash: resp.txhash
            })
                .then(function (receipt) {
                    spinOn();
                    var playerCard = $('#randomPlayerCard');
                    playerCard.attr('src', "./img/lottery_rolling.png");
                    console.log("receipt is:" + JSON.stringify(receipt))
                    setQuery = setInterval(function () {
                        setTxQuery();
                    }, 10000);
                })
        }

        function setTxQuery() {
            neb.api.getTransactionReceipt({
                hash: txhash
            })
                .then(function (receipt) {
                    console.log(receipt)
                    if (receipt.status == 1) {
                        console.log("tx success")
                        var result = JSON.parse(receipt.execute_result);
                        console.log(result.playerId)
                        getTotalPrize();
                        loadPlayerPicsById(result.playerId);
                        clearInterval(setQuery);
                        spinOff();
                        $.getJSON('./players.json', function (data) {
                            $("#modal-status").show().text("Congratulations! You just claimed ")
                            $("#talent").attr('class', showStars(result.talent));
                            $("#modal-txresult").show();
                            var playerCard = $('#randomPlayerCard');
                            playerCard.attr('src', "./img/lottery_quesitonMark.png");
                        });
                    }

                    if (receipt.status == 0) {
                        console.log("tx fail")
                        $("#modal-status").show().text("Sorry, your transaction failed")
                        clearInterval(setQuery);
                        spinOff();
                    }

                })
                .catch(function (err) {
                    console.log("didn't get a receipt")
                })
        }

        function loadPlayerPicsById(id) {
            // Load pets.
            console.log(id);
            $.getJSON('./players.json', function (data) {
                var namebar = $('#name');
                namebar.text(data[id].name);
                var playerCard = $('#playerCard');
                playerCard.attr('src', data[id].picture);
            });

        }


        var playerInfo;
        function getTotalToken(){
                    var testcontract;
                    var callJSONs = {
                        from: ownerAddress, // get address string
                        to: contractAddress, // get the contract string
                        value: "0",
                        nonce: 0,
                        gasPrice: "200000",
                        gasLimit: "1000000",
                        contract: testcontract
                    }
                    // get the token Id owned by the address
                    testcontract = { "function": "getTotalTokens", "args": "" };
                    callJSONs.contract = testcontract;
                    neb.api.call(callJSONs).
                    then(function (resp){
                        return resp.result; 
                    } 
                    ).then(function(resp){
                        var N = resp; 
                        var IDs = [];
                        for(var i=0;i<N;i++){
                            IDs.push(i);
                        }
                        console.log(IDs);        
                        getTokenInfoByIds(IDs)
                    })
            }


            var playersAmountData=[];
            var playerTalents=[];
            function getTokenInfoByIds(tokenIds){
                        var testcontract;
                        var callJSONs = {
                            from: ownerAddress, // get address string
                            to: contractAddress, // get the contract string
                            value: "0",
                            nonce: 0,
                            gasPrice: "200000",
                            gasLimit: "1000000",
                            contract: { "function": "getPlayersInfoByTokenId", "args": "[\"" + JSON.stringify(tokenIds) + "\"]" }
                        }
                    
                    neb.api.call(callJSONs).then(function (resp) {
                        playerInfo = JSON.parse(resp.result);   
                        console.log(playerInfo);   
                          $.getJSON('./players.json', function (data) {
                            playersAmountData =   [['Avatar', 'Generated Number']];
                              for (var i=0;i<data.length;i++){
                                var item=[data[i].name, countAmount(i)];
                                playersAmountData.push(item);        
                              }
   

                            google.charts.load("current", {packages:["corechart"]});
                            google.charts.setOnLoadCallback(drawChart1);
                            function drawChart1() {
                                var data = google.visualization.arrayToDataTable(playersAmountData);

                                var options = {
                                title: 'Generated Avatar Distribution',
                                pieHole: 0.4,
                                };

                                var chart = new google.visualization.PieChart(document.getElementById('playerchart'));
                                chart.draw(data, options);
                                $("#loader1").css("display", "none");
                            }

                            playerTalents =  [['Avatar', 'Talents']];
                            for (var i=1;i<6;i++){
                                playerTalents.push(["star "+i,findStars(i)]);
                            }

                            google.charts.load("current", {packages:["corechart"]});
                            google.charts.setOnLoadCallback(drawChart2);
                            function drawChart2() {
                                var data = google.visualization.arrayToDataTable(playerTalents);

                                var options = {
                                title: 'Generated Talent Distribution',
                                pieHole: 0.4,
                                };

                                var chart = new google.visualization.PieChart(document.getElementById('talentchart'));
                                chart.draw(data, options);
                                $("#loader2").css("display", "none");
                            }


                        });
                        // $("#tbody").empty();
                        // for (var i=0;i<playerInfo.length;i++){
                        //     $('#here_table').append('<tr><th scope="row">'+i+'</th>'+'<td>'+playerInfo[i].id+'</td>'
                        //         +'<td>'+database[playerInfo[i].id].name +'</td>'
                        //         +'<td>'+playerInfo[i].owner +'</td>'
                        //         +'<td>'+getPoints(playerInfo[i]) +'</td>'
                        //         +'<td>'+playerInfo[i].talent +'</td>'
                        //         +'<td>'+playerInfo[i].time +'</td>'
                        //         +'<td>'+playerInfo[i].win +'</td>'
                        //         +'<td>'+playerInfo[i].goal +'</td>'+'</tr>');
                        // }
                    })
            }


            function countAmount(index){
                var counter=0;
                for (var i=0; i<playerInfo.length;i++){
                    if(playerInfo[i].id==index){
                        counter++;
                    }
                }
                return counter;
            }

            function findStars(index){
                var counter=0;
                for (var i=0; i<playerInfo.length;i++){
                    if(playerInfo[i].talent==index){
                        counter++;
                    }
                }
                return counter;
            }




        function spinOn() {
            $("#myModal").modal();
            $("#modal-status").show().text("Please wait for your transaction to be completed")
            $("#loader3").css("display", "block");
            $("#confirm").hide();
            $("#modal-txresult").hide();
            $("#modal").show();
        }

        function spinOff() {
            $("#loader3").css("display", "none");
            $("#confirm").show();
        }

        function showStars(number) {
            return "stars-container stars-" + number;
        }




        $(window).load(function () {
            // executes when complete page is fully loaded, including all frames, objects and images
            init();
        });

    </script>

</body>

</html>